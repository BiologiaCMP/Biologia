<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jumpy Journey: Desafío Final</title>
    <style>
        /* Estilos del Juego (CSS Integrado) */
        body {
            font-family: 'Press Start 2P', cursive; /* Fuente retro */
            /* Si quieres esta fuente, puedes descomentar la línea de @import y buscar una forma de cargarla localmente o usar CDN.
            @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap'); */

            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #2c3e50; /* Fondo oscuro */
            color: #ecf0f1; /* Texto claro */
            margin: 0;
            overflow: hidden;
        }

        #game-container {
            background-color: #34495e; /* Fondo del contenedor */
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        h1 {
            color: #f1c40f; /* Título llamativo */
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }

        canvas {
            border: 3px solid #f1c40f; /* Borde del canvas */
            background-color: #7fd4e7; /* Fondo del cielo */
            display: block;
            margin: 0 auto;
        }

        #game-info {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 30px;
            font-size: 1.1em;
            color: #bdc3c7;
        }

        #game-over-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #ecf0f1;
            text-align: center;
            font-size: 1.5em;
            z-index: 100;
        }

        #game-over-screen h2 {
            color: #e74c3c; /* Rojo para Game Over */
            margin-bottom: 20px;
        }

        #restart-button {
            background-color: #27ae60; /* Verde para el botón */
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 20px;
            transition: background-color 0.3s ease;
        }

        #restart-button:hover {
            background-color: #2ecc71;
        }

        .hidden {
            display: none !important;
        }

        #boss-health-bar {
            width: 80%;
            height: 20px;
            background-color: #555;
            border: 2px solid #333;
            margin-top: 10px;
            border-radius: 5px;
            overflow: hidden;
            display: none; /* Oculto por defecto */
        }

        #boss-health-fill {
            height: 100%;
            width: 100%; /* Se ajusta con JS */
            background-color: #e74c3c;
            transition: width 0.1s ease-out;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>Jumpy Journey: Desafío Final</h1>
        <canvas id="gameCanvas" width="900" height="500"></canvas>
        <div id="game-info">
            <p>Puntos: <span id="score">0</span></p>
            <p>Vidas: <span id="lives">3</span></p>
            <p>Nivel: <span id="level-display">1</span></p>
        </div>
        <div id="boss-health-bar">
            <div id="boss-health-fill"></div>
        </div>
        <div id="game-over-screen" class="hidden">
            <h2 id="game-over-title">¡Juego Terminado!</h2>
            <p>Puntuación Final: <span id="final-score">0</span></p>
            <button id="restart-button">Jugar de Nuevo</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const scoreDisplay = document.getElementById('score');
        const livesDisplay = document.getElementById('lives');
        const levelDisplay = document.getElementById('level-display');
        const gameOverScreen = document.getElementById('game-over-screen');
        const gameOverTitle = document.getElementById('game-over-title');
        const finalScoreDisplay = document.getElementById('final-score');
        const restartButton = document.getElementById('restart-button');
        const bossHealthBar = document.getElementById('boss-health-bar');
        const bossHealthFill = document.getElementById('boss-health-fill');

        // --- Variables del Juego ---
        let score = 0;
        let lives = 3;
        let gameRunning = true;
        let currentLevelIndex = 0;

        const GRAVITY = 0.5;
        const GROUND_LEVEL = canvas.height - 40;
        const TILE_SIZE = 40;

        // --- Jugador ---
        const player = {
            x: 50,
            y: GROUND_LEVEL - TILE_SIZE,
            width: TILE_SIZE,
            height: TILE_SIZE,
            color: 'red',
            speed: 5,
            velocityY: 0,
            isJumping: false,
            onGround: true,
            hasFirePower: false, // Habilidad de disparar
            projectiles: [], // Array de proyectiles
            invincible: false,
            invincibilityTimer: 0,
            maxInvincibilityTime: 120 // Cuadros (2 segundos a 60 FPS)
        };

        // --- Array para Teclas Presionadas ---
        const keys = {
            right: false,
            left: false,
            space: false,
            fire: false, // Tecla para disparar
            canFire: true // Controla el cooldown del disparo
        };

        // --- Objeto Jefe Final ---
        const boss = {
            x: canvas.width / 2 - TILE_SIZE * 2,
            y: GROUND_LEVEL - TILE_SIZE * 4,
            width: TILE_SIZE * 4,
            height: TILE_SIZE * 4,
            color: 'darkred',
            maxHealth: 1000,
            health: 1000,
            speed: 1.5,
            dir: 1, // 1 para derecha, -1 para izquierda
            shootTimer: 0,
            shootInterval: 90, // Cuadros entre disparos
            active: false, // Solo activo en el nivel del jefe
            initialX: canvas.width / 2 - TILE_SIZE * 2,
            moveRange: 150 // Rango de movimiento horizontal
        };

        // --- Niveles del Juego ---
        const levels = [
            // Nivel 1: Introducción
            {
                bgColor: '#7fd4e7', // Cielo
                platforms: [
                    { x: 0, y: GROUND_LEVEL, width: canvas.width, height: TILE_SIZE, color: '#4CAF50' }, // Suelo
                    { x: 200, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 3, height: TILE_SIZE, color: '#8B4513' },
                    { x: 550, y: GROUND_LEVEL - TILE_SIZE * 3, width: TILE_SIZE * 2, height: TILE_SIZE, color: '#8B4513' }
                ],
                enemies: [
                    { x: 300, y: GROUND_LEVEL - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, color: '#800080', speed: 1.5, type: 'goomber', dir: 1, initialX: 300, moveRange: 100 }
                ],
                obstacles: [],
                powerUps: [
                    { x: 100, y: GROUND_LEVEL - TILE_SIZE * 2, width: 20, height: 20, color: 'yellow', type: 'score' }
                ],
                exit: { x: canvas.width - TILE_SIZE * 2, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE, height: TILE_SIZE, color: 'gold' }
            },
            // Nivel 2: Primeros Spikes y más Goombers
            {
                bgColor: '#7fd4e7',
                platforms: [
                    { x: 0, y: GROUND_LEVEL, width: canvas.width, height: TILE_SIZE, color: '#4CAF50' },
                    { x: 150, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 3, height: TILE_SIZE, color: '#8B4513' },
                    { x: 500, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 2, height: TILE_SIZE, color: '#8B4513' }
                ],
                enemies: [
                    { x: 200, y: GROUND_LEVEL - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, color: '#800080', speed: 2, type: 'goomber', dir: 1, initialX: 200, moveRange: 100 },
                    { x: 600, y: GROUND_LEVEL - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, color: '#800080', speed: 2, type: 'goomber', dir: -1, initialX: 600, moveRange: 100 }
                ],
                obstacles: [
                    { x: 350, y: GROUND_LEVEL - 20, width: TILE_SIZE * 1.5, height: 20, color: '#333', type: 'spike' }
                ],
                powerUps: [
                    { x: 50, y: GROUND_LEVEL - TILE_SIZE * 2, width: 20, height: 20, color: 'yellow', type: 'score' }
                ],
                exit: { x: canvas.width - TILE_SIZE * 2, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE, height: TILE_SIZE, color: 'gold' }
            },
            // Nivel 3: Spikers y Plataformas Elevadas
            {
                bgColor: '#7fd4e7',
                platforms: [
                    { x: 0, y: GROUND_LEVEL, width: canvas.width, height: TILE_SIZE, color: '#4CAF50' },
                    { x: 100, y: GROUND_LEVEL - TILE_SIZE * 3, width: TILE_SIZE * 2, height: TILE_SIZE, color: '#8B4513' },
                    { x: 400, y: GROUND_LEVEL - TILE_SIZE * 4, width: TILE_SIZE * 3, height: TILE_SIZE, color: '#8B4513' },
                    { x: 700, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 1.5, height: TILE_SIZE, color: '#8B4513' }
                ],
                enemies: [
                    { x: 450, y: GROUND_LEVEL - TILE_SIZE * 5, width: TILE_SIZE, height: TILE_SIZE, color: '#FF4500', type: 'spiker' } // Spiker fijo
                ],
                obstacles: [
                    { x: 250, y: GROUND_LEVEL - 20, width: TILE_SIZE, height: 20, color: '#333', type: 'spike' },
                    { x: 600, y: GROUND_LEVEL - 20, width: TILE_SIZE, height: 20, color: '#333', type: 'spike' }
                ],
                powerUps: [
                    { x: 750, y: GROUND_LEVEL - TILE_SIZE * 3, width: 20, height: 20, color: 'blue', type: 'extraLife' }
                ],
                exit: { x: canvas.width - TILE_SIZE * 2, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE, height: TILE_SIZE, color: 'gold' }
            },
            // Nivel 4: Primeros Flutterbys y Flor de Fuego
            {
                bgColor: '#7fd4e7',
                platforms: [
                    { x: 0, y: GROUND_LEVEL, width: canvas.width, height: TILE_SIZE, color: '#4CAF50' },
                    { x: 100, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 2, height: TILE_SIZE, color: '#8B4513' },
                    { x: 400, y: GROUND_LEVEL - TILE_SIZE * 3, width: TILE_SIZE * 2, height: TILE_SIZE, color: '#8B4513' }
                ],
                enemies: [
                    { x: 300, y: 100, width: TILE_SIZE, height: TILE_SIZE, color: '#00FFFF', speed: 1, type: 'flutterby', dir: 1, initialY: 100, range: 50 } // Flutterby
                ],
                obstacles: [],
                powerUps: [
                    { x: 250, y: GROUND_LEVEL - TILE_SIZE * 3, width: 20, height: 20, color: 'orange', type: 'fireFlower' } // Flor de fuego
                ],
                exit: { x: canvas.width - TILE_SIZE * 2, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE, height: TILE_SIZE, color: 'gold' }
            },
            // Nivel 5: Turret Plants y Pinchos Móviles
            {
                bgColor: '#5a6a7a', // Fondo más oscuro para simular cueva
                platforms: [
                    { x: 0, y: GROUND_LEVEL, width: canvas.width, height: TILE_SIZE, color: '#4CAF50' },
                    { x: 250, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 4, height: TILE_SIZE, color: '#8B4513' }
                ],
                enemies: [
                    { x: 100, y: GROUND_LEVEL - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, color: '#800080', speed: 1.5, type: 'goomber', dir: 1, initialX: 100, moveRange: 100 },
                    { x: 700, y: GROUND_LEVEL - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, color: '#800080', speed: 1.5, type: 'goomber', dir: -1, initialX: 700, moveRange: 100 }
                ],
                obstacles: [
                    { x: 400, y: GROUND_LEVEL - 20, width: TILE_SIZE, height: 20, color: '#333', type: 'spike', moving: true, initialY: GROUND_LEVEL - 20, maxY: GROUND_LEVEL - TILE_SIZE * 2, speed: 1, dir: 1 },
                    { x: 50, y: GROUND_LEVEL - 20, width: TILE_SIZE, height: TILE_SIZE, color: '#7CFC00', type: 'turretPlant', shootTimer: 0, shootInterval: 90 }
                ],
                powerUps: [],
                exit: { x: canvas.width - TILE_SIZE * 2, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE, height: TILE_SIZE, color: 'gold' }
            },
            // Nivel 6: Plataformas que Desaparecen y Spikers
            {
                bgColor: '#5a6a7a',
                platforms: [
                    { x: 0, y: GROUND_LEVEL, width: canvas.width, height: TILE_SIZE, color: '#4CAF50' },
                    { x: 100, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 2, height: TILE_SIZE, color: '#A0522D', type: 'crumbling' },
                    { x: 300, y: GROUND_LEVEL - TILE_SIZE * 3, width: TILE_SIZE * 2, height: TILE_SIZE, color: '#8B4513' },
                    { x: 500, y: GROUND_LEVEL - TILE_SIZE * 4, width: TILE_SIZE * 2, height: TILE_SIZE, color: '#A0522D', type: 'crumbling' },
                    { x: 700, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 2, height: TILE_SIZE, color: '#8B4513' }
                ],
                enemies: [
                    { x: 350, y: GROUND_LEVEL - TILE_SIZE * 4, width: TILE_SIZE, height: TILE_SIZE, color: '#FF4500', type: 'spiker' }
                ],
                obstacles: [],
                powerUps: [
                    { x: 50, y: GROUND_LEVEL - TILE_SIZE * 3, width: 20, height: 20, color: 'blue', type: 'extraLife' }
                ],
                exit: { x: canvas.width - TILE_SIZE * 2, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE, height: TILE_SIZE, color: 'gold' }
            },
            // Nivel 7: Primeros Jumpers y Chargers
            {
                bgColor: '#7fd4e7',
                platforms: [
                    { x: 0, y: GROUND_LEVEL, width: canvas.width, height: TILE_SIZE, color: '#4CAF50' },
                    { x: 150, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 2, height: TILE_SIZE, color: '#8B4513' },
                    { x: 500, y: GROUND_LEVEL - TILE_SIZE * 3, width: TILE_SIZE * 3, height: TILE_SIZE, color: '#8B4513' }
                ],
                enemies: [
                    { x: 200, y: GROUND_LEVEL - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, color: 'purple', speed: 1.5, type: 'jumper', jumpTimer: 0, jumpInterval: 180 }, // Jumper
                    { x: 600, y: GROUND_LEVEL - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, color: 'brown', speed: 2, type: 'charger', chargeSpeed: 5, chargeRange: 200, charging: false, initialX: 600, moveRange: 100 } // Charger
                ],
                obstacles: [],
                powerUps: [
                    { x: 700, y: GROUND_LEVEL - TILE_SIZE * 4, width: 20, height: 20, color: 'yellow', type: 'score' }
                ],
                exit: { x: canvas.width - TILE_SIZE * 2, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE, height: TILE_SIZE, color: 'gold' }
            },
            // Nivel 8: Combinación de Enemigos y Obstáculos
            {
                bgColor: '#5a6a7a',
                platforms: [
                    { x: 0, y: GROUND_LEVEL, width: canvas.width, height: TILE_SIZE, color: '#4CAF50' },
                    { x: 100, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 2, height: TILE_SIZE, color: '#8B4513' },
                    { x: 400, y: GROUND_LEVEL - TILE_SIZE * 3, width: TILE_SIZE * 3, height: TILE_SIZE, color: '#8B4513' },
                    { x: 700, y: GROUND_LEVEL - TILE_SIZE * 4, width: TILE_SIZE * 2, height: TILE_SIZE, color: '#8B4513' }
                ],
                enemies: [
                    { x: 200, y: GROUND_LEVEL - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, color: '#800080', speed: 2, type: 'goomber', dir: 1, initialX: 200, moveRange: 100 },
                    { x: 500, y: 100, width: TILE_SIZE, height: TILE_SIZE, color: '#00FFFF', speed: 1.5, type: 'flutterby', dir: 1, initialY: 100, range: 70 }
                ],
                obstacles: [
                    { x: 300, y: GROUND_LEVEL - 20, width: TILE_SIZE, height: 20, color: '#333', type: 'spike' },
                    { x: 600, y: GROUND_LEVEL - 20, width: TILE_SIZE, height: TILE_SIZE, color: '#7CFC00', type: 'turretPlant', shootTimer: 0, shootInterval: 60 }
                ],
                powerUps: [],
                exit: { x: canvas.width - TILE_SIZE * 2, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE, height: TILE_SIZE, color: 'gold' }
            },
            // Nivel 9: Desafío de Habilidad (plataformas móviles)
            {
                bgColor: '#5a6a7a',
                platforms: [
                    { x: 0, y: GROUND_LEVEL, width: canvas.width, height: TILE_SIZE, color: '#4CAF50' },
                    { x: 100, y: 200, width: TILE_SIZE * 2, height: TILE_SIZE, color: '#8B4513', type: 'moving', initialX: 100, maxX: 300, speed: 1.5, dir: 1 },
                    { x: 500, y: 150, width: TILE_SIZE * 2, height: TILE_SIZE, color: '#8B4513', type: 'moving', initialX: 500, maxX: 700, speed: 1.5, dir: -1 }
                ],
                enemies: [
                    { x: 200, y: GROUND_LEVEL - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, color: 'brown', speed: 2, type: 'charger', chargeSpeed: 6, chargeRange: 250, charging: false, initialX: 200, moveRange: 100 },
                    { x: 700, y: GROUND_LEVEL - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, color: 'purple', speed: 1.8, type: 'jumper', jumpTimer: 0, jumpInterval: 150 }
                ],
                obstacles: [
                    { x: 350, y: GROUND_LEVEL - 20, width: TILE_SIZE * 2, height: 20, color: '#333', type: 'spike' }
                ],
                powerUps: [
                    { x: 50, y: 150, width: 20, height: 20, color: 'orange', type: 'fireFlower' }
                ],
                exit: { x: canvas.width - TILE_SIZE * 2, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE, height: TILE_SIZE, color: 'gold' }
            },
            // Nivel 10: ¡El JEFE FINAL!
            {
                bgColor: '#8B0000', // Fondo rojo oscuro (lava)
                platforms: [
                    { x: 0, y: GROUND_LEVEL, width: canvas.width, height: TILE_SIZE, color: '#4CAF50' },
                    { x: canvas.width / 2 - TILE_SIZE * 2, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 4, height: TILE_SIZE, color: '#8B4513' } // Plataforma para el jefe
                ],
                enemies: [], // No hay enemigos normales, solo el jefe
                obstacles: [],
                powerUps: [
                    { x: 100, y: GROUND_LEVEL - TILE_SIZE * 2, width: 20, height: 20, color: 'orange', type: 'fireFlower' } // Asegurar que el jugador tenga el arma
                ],
                exit: null, // No hay salida, se termina al derrotar al jefe
                isBossLevel: true
            }
        ];

        let currentLevelData;
        let gameProjectiles = []; // Proyectiles del jugador y de las torretas

        // --- Inicializar Nivel ---
        function loadLevel(levelNum) {
            if (levelNum >= levels.length) {
                console.log("¡Felicidades, has completado el juego!");
                showGameOver(true); // Victoria
                return;
            }
            currentLevelData = JSON.parse(JSON.stringify(levels[levelNum])); // Copia profunda
            player.x = 50;
            player.y = GROUND_LEVEL - TILE_SIZE;
            player.velocityY = 0;
            player.isJumping = false;
            player.onGround = true;
            player.invincible = false;
            player.invincibilityTimer = 0;
            gameProjectiles = []; // Limpiar proyectiles al cambiar de nivel
            levelDisplay.textContent = currentLevelIndex + 1;

            // Reiniciar estado del jefe si es el nivel del jefe
            if (currentLevelData.isBossLevel) {
                boss.active = true;
                boss.health = boss.maxHealth;
                boss.x = boss.initialX;
                boss.dir = 1;
                boss.shootTimer = 0; // Resetear timer de disparo del jefe
                bossHealthBar.style.display = 'block'; // Mostrar barra de vida del jefe
                updateBossHealthBar();
            } else {
                boss.active = false;
                bossHealthBar.style.display = 'none'; // Ocultar barra de vida del jefe
            }

            // Si el jugador no tiene el poder de fuego, resetear su color
            if (!player.hasFirePower) {
                player.color = 'red';
            } else {
                player.color = 'blue'; // Mantener el color si tiene el poder
            }
        }

        // --- Bucle Principal del Juego ---
        function gameLoop() {
            if (!gameRunning) return;

            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // --- Actualizar Estado del Juego ---
        function update() {
            // 1. Movimiento del Jugador
            if (keys.right) player.x += player.speed;
            if (keys.left) player.x -= player.speed;

            // Limitar movimiento dentro del canvas
            if (player.x < 0) player.x = 0;
            if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;

            // 2. Gravedad
            player.y += player.velocityY;
            player.velocityY += GRAVITY;

            // 3. Saltar
            if (keys.space && player.onGround) {
                player.velocityY = -10; // Fuerza de salto
                player.isJumping = true;
                player.onGround = false;
            }

            // 4. Disparar (con Fire Flower)
            if (keys.fire && player.hasFirePower && keys.canFire) {
                gameProjectiles.push({
                    x: player.x + player.width / 2 - 5,
                    y: player.y + player.height / 2 - 5,
                    width: 10,
                    height: 10,
                    color: 'orange',
                    speed: 8,
                    dir: keys.right ? 1 : (keys.left ? -1 : (player.x + player.width / 2 > canvas.width / 2 ? 1 : -1)), // Dispara en la última dirección o hacia la mitad del lienzo
                    isPlayerProjectile: true
                });
                keys.canFire = false; // Desactivar disparo hasta soltar la tecla
                setTimeout(() => keys.canFire = true, 200); // Cooldown de 200ms
            }

            // 5. Actualizar Proyectiles
            gameProjectiles.forEach((proj, index) => {
                proj.x += proj.speed * proj.dir;
                // Remover proyectiles fuera de pantalla
                if (proj.x < 0 || proj.x > canvas.width || proj.y < 0 || proj.y > canvas.height) {
                    gameProjectiles.splice(index, 1);
                }
            });

            // 6. Colisiones con Plataformas
            player.onGround = false;
            currentLevelData.platforms.forEach(platform => {
                // Actualizar plataformas móviles
                if (platform.type === 'moving') {
                    if (platform.dir === 1) {
                        platform.x += platform.speed;
                        if (platform.x >= platform.maxX) {
                            platform.dir = -1;
                        }
                    } else {
                        platform.x -= platform.speed;
                        if (platform.x <= platform.initialX) {
                            platform.dir = 1;
                        }
                    }
                }

                if (checkCollision(player, platform)) {
                    if (player.velocityY > 0 && player.y + player.height - player.velocityY <= platform.y) {
                        player.y = platform.y - player.height;
                        player.velocityY = 0;
                        player.onGround = true;
                        player.isJumping = false;

                        // Plataformas que desaparecen
                        if (platform.type === 'crumbling') {
                            platform.crumblingTimer = platform.crumblingTimer || 0;
                            platform.crumblingTimer++;
                            if (platform.crumblingTimer > 30) { // Desaparece después de 0.5 segundos
                                platform.exists = false;
                            }
                        }
                    } else if (player.velocityY < 0 && player.y >= platform.y + platform.height - 5) {
                        player.velocityY = 0; // Detiene el salto ascendente
                    }
                }
            });
            // Filtrar plataformas que han desaparecido
            currentLevelData.platforms = currentLevelData.platforms.filter(p => p.exists !== false);

            // Asegurarse de que el jugador no caiga por debajo del suelo
            if (player.y + player.height > GROUND_LEVEL) {
                player.y = GROUND_LEVEL - player.height;
                player.velocityY = 0;
                player.onGround = true;
                player.isJumping = false;
            }

            // 7. Actualizar Enemigos
            currentLevelData.enemies.forEach(enemy => {
                if (enemy.type === 'goomber') {
                    if (enemy.dir === 1 && enemy.x >= enemy.initialX + enemy.moveRange) {
                        enemy.dir = -1;
                    } else if (enemy.dir === -1 && enemy.x <= enemy.initialX - enemy.moveRange) {
                        enemy.dir = 1;
                    }
                    enemy.x += enemy.speed * enemy.dir;
                } else if (enemy.type === 'flutterby') {
                    if (enemy.dir === 1) { // Mover hacia abajo
                        enemy.y += enemy.speed;
                        if (enemy.y >= enemy.initialY + enemy.range) {
                            enemy.dir = -1;
                        }
                    } else { // Mover hacia arriba
                        enemy.y -= enemy.speed;
                        if (enemy.y <= enemy.initialY - enemy.range) {
                            enemy.dir = 1;
                        }
                    }
                } else if (enemy.type === 'jumper') {
                    enemy.jumpTimer++;
                    if (enemy.jumpTimer >= enemy.jumpInterval) {
                        enemy.velocityY = -8; // Fuerza de salto del jumper
                        enemy.jumpTimer = 0;
                    }
                    enemy.y += enemy.velocityY;
                    enemy.velocityY += GRAVITY;
                } else if (enemy.type === 'charger') {
                    const distanceToPlayer = Math.abs(player.x - enemy.x);
                    if (distanceToPlayer < enemy.chargeRange && !enemy.charging) {
                        enemy.charging = true;
                        enemy.chargeDir = (player.x < enemy.x) ? -1 : 1;
                    }

                    if (enemy.charging) {
                        enemy.x += enemy.chargeSpeed * enemy.chargeDir;
                        // Detener la carga si se aleja mucho o golpea algo
                        if (distanceToPlayer > enemy.chargeRange * 1.5 || checkCollision(enemy, player)) {
                            enemy.charging = false;
                            enemy.chargeDir = 0;
                        }
                    } else {
                         // Movimiento normal cuando no está cargando
                        if (enemy.dir === 1 && enemy.x >= enemy.initialX + enemy.moveRange) {
                            enemy.dir = -1;
                        } else if (enemy.dir === -1 && enemy.x <= enemy.initialX - enemy.moveRange) {
                            enemy.dir = 1;
                        }
                        enemy.x += enemy.speed * enemy.dir;
                    }
                }

                // Aplicar gravedad a los enemigos si no están sobre una plataforma
                let enemyOnPlatform = false;
                currentLevelData.platforms.forEach(platform => {
                    if (checkCollision({ x: enemy.x, y: enemy.y + enemy.height + 1, width: enemy.width, height: 1 }, platform)) {
                        enemyOnPlatform = true;
                        enemy.y = platform.y - enemy.height; // Alinear al suelo de la plataforma
                        if (enemy.type === 'jumper') enemy.velocityY = 0; // Detener caída del jumper
                    }
                });
                if (!enemyOnPlatform && enemy.y + enemy.height < GROUND_LEVEL) {
                     enemy.y += GRAVITY * 2; // Caída más rápida para enemigos
                } else if (enemy.y + enemy.height > GROUND_LEVEL) {
                    enemy.y = GROUND_LEVEL - enemy.height;
                    if (enemy.type === 'jumper') enemy.velocityY = 0;
                }
            });

            // 8. Detección de Colisión Jugador-Enemigo
            if (!player.invincible) {
                currentLevelData.enemies.forEach((enemy, index) => {
                    if (checkCollision(player, enemy)) {
                        if (player.velocityY > 0 && player.y + player.height - player.velocityY <= enemy.y && enemy.type !== 'spiker') {
                            // Jugador salta sobre el enemigo (aplastar)
                            updateScore(100);
                            currentLevelData.enemies.splice(index, 1);
                            player.velocityY = -7; // Pequeño rebote
                            player.isJumping = true;
                        } else {
                            // Jugador es golpeado
                            takeDamage();
                        }
                    }
                });
            } else {
                player.invincibilityTimer--;
                if (player.invincibilityTimer <= 0) {
                    player.invincible = false;
                }
            }

            // 9. Colisiones de Proyectiles del Jugador con Enemigos
            gameProjectiles.forEach((proj, projIndex) => {
                if (proj.isPlayerProjectile) {
                    currentLevelData.enemies.forEach((enemy, enemyIndex) => {
                        if (checkCollision(proj, enemy) && enemy.type !== 'spiker') { // Proyectiles no afectan Spikers
                            updateScore(150);
                            gameProjectiles.splice(projIndex, 1);
                            currentLevelData.enemies.splice(enemyIndex, 1);
                        }
                    });
                }
            });

            // 10. Colisiones con Obstáculos
            currentLevelData.obstacles.forEach(obstacle => {
                // Pinchos móviles
                if (obstacle.type === 'spike' && obstacle.moving) {
                    if (obstacle.dir === 1) { // Subir
                        obstacle.y -= obstacle.speed;
                        if (obstacle.y <= obstacle.maxY) {
                            obstacle.dir = -1;
                        }
                    } else { // Bajar
                        obstacle.y += obstacle.speed;
                        if (obstacle.y >= obstacle.initialY) {
                            obstacle.dir = 1;
                        }
                    }
                }
                // Plantas torreta
                if (obstacle.type === 'turretPlant') {
                    obstacle.shootTimer++;
                    if (obstacle.shootTimer >= obstacle.shootInterval) {
                        gameProjectiles.push({
                            x: obstacle.x + obstacle.width / 2,
                            y: obstacle.y - 10, // Dispara desde arriba
                            width: 8,
                            height: 8,
                            color: 'firebrick',
                            speed: 5,
                            dir: (player.x < obstacle.x) ? -1 : 1, // Dispara hacia el jugador
                            isEnemyProjectile: true
                        });
                        obstacle.shootTimer = 0;
                    }
                }

                if (checkCollision(player, obstacle) && !player.invincible) {
                    if (obstacle.type === 'spike') {
                        takeDamage();
                    }
                }
            });

            // 11. Colisiones de Proyectiles Enemigos con Jugador
            gameProjectiles.forEach((proj, index) => {
                if (proj.isEnemyProjectile && checkCollision(player, proj) && !player.invincible) {
                    takeDamage();
                    gameProjectiles.splice(index, 1); // Remover proyectil después de golpear
                }
            });

            // 12. Colisiones con Power-ups
            currentLevelData.powerUps.forEach((powerUp, index) => {
                if (checkCollision(player, powerUp)) {
                    if (powerUp.type === 'score') {
                        updateScore(50);
                    } else if (powerUp.type === 'extraLife') {
                        updateLives(1);
                    } else if (powerUp.type === 'fireFlower') {
                        player.hasFirePower = true;
                        player.color = 'blue'; // Cambia de color al obtener poder
                    }
                    currentLevelData.powerUps.splice(index, 1); // Eliminar power-up
                }
            });

            // 13. Lógica del Jefe Final (si es el nivel del jefe)
            if (currentLevelData.isBossLevel && boss.active) {
                // Movimiento del jefe
                if (boss.dir === 1 && boss.x >= boss.initialX + boss.moveRange) {
                    boss.dir = -1;
                } else if (boss.dir === -1 && boss.x <= boss.initialX - boss.moveRange) {
                    boss.dir = 1;
                }
                boss.x += boss.speed * boss.dir;

                // Disparo del jefe
                boss.shootTimer++;
                if (boss.shootTimer >= boss.shootInterval) {
                    gameProjectiles.push({
                        x: boss.x + boss.width / 2,
                        y: boss.y + boss.height / 2,
                        width: 15,
                        height: 15,
                        color: 'purple',
                        speed: 6,
                        dir: (player.x < boss.x) ? -1 : 1,
                        isEnemyProjectile: true
                    });
                    boss.shootTimer = 0;
                }

                // Colisión Jugador-Jefe
                if (checkCollision(player, boss) && !player.invincible) {
                    takeDamage();
                }

                // Colisión Proyectil Jugador-Jefe
                gameProjectiles.forEach((proj, projIndex) => {
                    if (proj.isPlayerProjectile && checkCollision(proj, boss)) {
                        boss.health -= 50; // Daño al jefe
                        updateBossHealthBar();
                        gameProjectiles.splice(projIndex, 1); // Eliminar proyectil

                        if (boss.health <= 0) {
                            updateScore(5000); // Gran bonificación por derrotar al jefe
                            boss.active = false;
                            showGameOver(true); // ¡Juego Completado!
                        }
                    }
                });
            }


            // 14. Colisión con la Salida (solo si no es nivel de jefe)
            if (!currentLevelData.isBossLevel && currentLevelData.exit && checkCollision(player, currentLevelData.exit)) {
                currentLevelIndex++;
                updateScore(500); // Bonificación por nivel
                loadLevel(currentLevelIndex); // Intentar cargar el siguiente nivel
            }
        }

        // --- Dibujar Elementos del Juego ---
        function draw() {
            ctx.fillStyle = currentLevelData.bgColor; // Fondo del nivel
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Dibujar suelo y plataformas
            currentLevelData.platforms.forEach(platform => {
                if (platform.exists !== false) { // Solo dibuja si existe
                    ctx.fillStyle = platform.color;
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                }
            });

            // Dibujar Jugador
            ctx.fillStyle = player.invincible ? 'rgba(255, 0, 0, 0.5)' : player.color;
            ctx.fillRect(player.x, player.y, player.width, player.height);

            // Dibujar Enemigos
            currentLevelData.enemies.forEach(enemy => {
                ctx.fillStyle = enemy.color;
                ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
            });

            // Dibujar Obstáculos
            currentLevelData.obstacles.forEach(obstacle => {
                ctx.fillStyle = obstacle.color;
                ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
            });

            // Dibujar Power-ups
            currentLevelData.powerUps.forEach(powerUp => {
                ctx.fillStyle = powerUp.color;
                ctx.fillRect(powerUp.x, powerUp.y, powerUp.width, powerUp.height);
            });

            // Dibujar Salida (si no es nivel de jefe)
            if (!currentLevelData.isBossLevel && currentLevelData.exit) {
                ctx.fillStyle = currentLevelData.exit.color;
                ctx.fillRect(currentLevelData.exit.x, currentLevelData.exit.y, currentLevelData.exit.width, currentLevelData.exit.height);
            }

            // Dibujar Proyectiles
            gameProjectiles.forEach(proj => {
                ctx.fillStyle = proj.color;
                ctx.fillRect(proj.x, proj.y, proj.width, proj.height);
            });

            // Dibujar Jefe (si está activo)
            if (boss.active) {
                ctx.fillStyle = boss.color;
                ctx.fillRect(boss.x, boss.y, boss.width, boss.height);
            }
        }

        // --- Funciones Auxiliares ---

        // Función de detección de colisiones AABB (Axis-Aligned Bounding Box)
        function checkCollision(obj1, obj2) {
            return obj1.x < obj2.x + obj2.width &&
                   obj1.x + obj1.width > obj2.x &&
                   obj1.y < obj2.y + obj2.height &&
                   obj1.y + obj1.height > obj2.y;
        }

        function updateScore(points) {
            score += points;
            scoreDisplay.textContent = score;
        }

        function updateLives(change) {
            lives += change;
            livesDisplay.textContent = lives;
            if (lives <= 0) {
                showGameOver(false);
            }
        }

        function takeDamage() {
            player.invincible = true;
            player.invincibilityTimer = player.maxInvincibilityTime;
            updateLives(-1);
            if (player.hasFirePower) { // Pierde el poder si es golpeado
                player.hasFirePower = false;
                player.color = 'red';
            }
            // Puedes agregar sonido o efecto visual aquí
        }

        function updateBossHealthBar() {
            const healthPercentage = (boss.health / boss.maxHealth) * 100;
            bossHealthFill.style.width = `${healthPercentage}%`;
        }

        function showGameOver(won = false) {
            gameRunning = false;
            finalScoreDisplay.textContent = score;
            gameOverTitle.textContent = won ? '¡Juego Completado!' : '¡Juego Terminado!';
            gameOverScreen.classList.remove('hidden');
        }

        function restartGame() {
            score = 0;
            lives = 3;
            currentLevelIndex = 0;
            player.hasFirePower = false; // Resetear poderes al reiniciar
            player.color = 'red';
            updateScore(0);
            updateLives(0);
            gameOverScreen.classList.add('hidden');
            bossHealthBar.style.display = 'none'; // Asegurarse de ocultar la barra del jefe
            gameRunning = true;
            loadLevel(currentLevelIndex);
            gameLoop();
        }

        // --- Event Listeners para el Teclado ---
        document.addEventListener('keydown', (e) => {
            if (e.code === 'ArrowRight' || e.code === 'KeyD') {
                keys.right = true;
            } else if (e.code === 'ArrowLeft' || e.code === 'KeyA') {
                keys.left = true;
            } else if (e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'KeyW') {
                keys.space = true;
            } else if (e.code === 'KeyF' && player.hasFirePower && keys.canFire) { // Tecla F para disparar
                keys.fire = true;
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.code === 'ArrowRight' || e.code === 'KeyD') {
                keys.right = false;
            } else if (e.code === 'ArrowLeft' || e.code === 'KeyA') {
                keys.left = false;
            } else if (e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'KeyW') {
                keys.space = false;
            } else if (e.code === 'KeyF') {
                keys.fire = false;
                keys.canFire = true; // Permite volver a disparar al soltar la tecla
            }
        });

        restartButton.addEventListener('click', restartGame);

        // --- Iniciar el Juego ---
        loadLevel(currentLevelIndex);
        gameLoop();
    </script>
</body>
</html>
