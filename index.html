<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jumpy Journey: Edición Pixel Art</title>
    <style>
        /* Estilos del Juego (CSS Integrado) */
        body {
            font-family: 'Press Start 2P', cursive; /* Fuente retro */
            /* Si quieres esta fuente, puedes descomentar la línea de @import y buscar una forma de cargarla localmente o usar CDN.
            @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap'); */

            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #2c3e50; /* Fondo oscuro */
            color: #ecf0f1; /* Texto claro */
            margin: 0;
            overflow: hidden;
        }

        #game-container {
            background-color: #34495e; /* Fondo del contenedor */
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        h1 {
            color: #f1c40f; /* Título llamativo */
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }

        canvas {
            border: 3px solid #f1c40f; /* Borde del canvas */
            background-color: #7fd4e7; /* Fondo del cielo por defecto */
            display: block;
            margin: 0 auto;
        }

        #game-info {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 30px;
            font-size: 1.1em;
            color: #bdc3c7;
        }

        #game-over-screen, #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #ecf0f1;
            text-align: center;
            font-size: 1.5em;
            z-index: 100;
        }

        #game-over-screen h2 {
            color: #e74c3c; /* Rojo para Game Over */
            margin-bottom: 20px;
        }

        #restart-button {
            background-color: #27ae60; /* Verde para el botón */
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 20px;
            transition: background-color 0.3s ease;
        }

        #restart-button:hover {
            background-color: #2ecc71;
        }

        .hidden {
            display: none !important;
        }

        #boss-health-bar {
            width: 80%;
            height: 20px;
            background-color: #555;
            border: 2px solid #333;
            margin-top: 10px;
            border-radius: 5px;
            overflow: hidden;
            display: none; /* Oculto por defecto */
        }

        #boss-health-fill {
            height: 100%;
            width: 100%; /* Se ajusta con JS */
            background-color: #e74c3c;
            transition: width 0.1s ease-out;
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <p>Cargando recursos...</p>
    </div>

    <div id="game-container" class="hidden">
        <h1>Jumpy Journey Avanzado</h1>
        <canvas id="gameCanvas" width="900" height="500"></canvas>
        <div id="game-info">
            <p>Puntos: <span id="score">0</span></p>
            <p>Vidas: <span id="lives">3</span></p>
            <p>Nivel: <span id="level-display">1</span></p>
        </div>
        <div id="boss-health-bar">
            <div id="boss-health-fill"></div>
        </div>
        <div id="game-over-screen" class="hidden">
            <h2 id="game-over-title">¡Juego Terminado!</h2>
            <p>Puntuación Final: <span id="final-score">0</span></p>
            <button id="restart-button">Jugar de Nuevo</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const scoreDisplay = document.getElementById('score');
        const livesDisplay = document.getElementById('lives');
        const levelDisplay = document.getElementById('level-display');
        const gameOverScreen = document.getElementById('game-over-screen');
        const gameOverTitle = document.getElementById('game-over-title');
        const finalScoreDisplay = document.getElementById('final-score');
        const restartButton = document.getElementById('restart-button');
        const loadingScreen = document.getElementById('loading-screen');
        const gameContainer = document.getElementById('game-container');
        const bossHealthBar = document.getElementById('boss-health-bar');
        const bossHealthFill = document.getElementById('boss-health-fill');

        // --- Variables del Juego ---
        let score = 0;
        let lives = 3;
        let gameRunning = false; // Se inicia en false hasta que las imágenes carguen
        let currentLevelIndex = 0;

        const GRAVITY = 0.5;
        const GROUND_LEVEL = canvas.height - 40;
        const TILE_SIZE = 40;

        // --- Jugador ---
        const player = {
            x: 50,
            y: GROUND_LEVEL - TILE_SIZE,
            width: TILE_SIZE,
            height: TILE_SIZE,
            speed: 5,
            velocityY: 0,
            isJumping: false,
            onGround: true,
            hasFirePower: false,
            projectiles: [],
            invincible: false,
            invincibilityTimer: 0,
            maxInvincibilityTime: 120 // 2 segundos a 60 FPS
        };

        // --- Array para Teclas Presionadas ---
        const keys = {
            right: false,
            left: false,
            space: false,
            fire: false,
            canFire: true // Controla el cooldown del disparo
        };

        // --- Assets de Imágenes ---
        const images = {};
        const imageSources = {
            player: 'https://i.imgur.com/gK9p5M9.png', // Nuevo jugador (personaje con gorra y overol azul)
            playerFire: 'https://i.imgur.com/gK9p5M9.png', // Mismo jugador para fuego (podrías tener una versión con animación de fuego)
            goomber: 'https://i.imgur.com/S6e1lqC.png', // Nuevo enemigo tipo Goomba (champiñón)
            spiker: 'https://i.imgur.com/1mX1r6d.png', // Nuevo enemigo tipo Spiker (erizo con pinchos)
            flutterby: 'https://i.imgur.com/X5vH3kF.png', // Nuevo enemigo volador (mariposa/libélula)
            turretPlant: 'https://i.imgur.com/9C7C8wP.png', // Nueva planta torreta (planta carnívora)
            spikeTrap: 'https://i.imgur.com/k2gC14Z.png', // Nueva trampa de pinchos
            platform: 'https://i.imgur.com/R3pS4qT.png', // Nueva plataforma de tierra/hierba
            crumblingPlatform: 'https://i.imgur.com/vH1N2vF.png', // Nueva plataforma que se rompe
            backgroundForest: 'https://i.imgur.com/6X7p3cE.png', // Nuevo fondo de bosque
            backgroundCave: 'https://i.imgur.com/sW4Y2gN.png', // Nuevo fondo de cueva
            backgroundLava: 'https://i.imgur.com/0F8r9zC.png', // Nuevo fondo de lava
            coin: 'https://i.imgur.com/J3qW4qR.png', // Nueva moneda
            heart: 'https://i.imgur.com/w2Yg8qQ.png', // Nueva vida extra (corazón)
            fireFlower: 'https://i.imgur.com/Z4w0X0F.png', // Nueva flor de fuego
            exitFlag: 'https://i.imgur.com/cQ0L7uY.png', // Nueva bandera de salida
            playerFireball: 'https://i.imgur.com/Q7u1e1O.png', // Nuevo proyectil del jugador (bola de fuego)
            enemyProjectile: 'https://i.imgur.com/D8k1F2R.png', // Nuevo proyectil del enemigo
            boss: 'https://i.imgur.com/e2o8m7C.png', // Nuevo jefe final (dragón)
            bossProjectile: 'https://i.imgur.com/e9w0h2X.png' // Nuevo proyectil del jefe (aliento de fuego)
        };


        let loadedImagesCount = 0;
        const totalImages = Object.keys(imageSources).length;

        function loadImage(name, src) {
            const img = new Image();
            img.src = src;
            img.onload = () => {
                images[name] = img;
                loadedImagesCount++;
                if (loadedImagesCount === totalImages) {
                    startGame();
                }
            };
            img.onerror = () => {
                console.error(`Error cargando imagen: ${src}`);
                // Podrías manejar esto mostrando un mensaje de error o usando un color de fallback
                images[name] = null; // Marca la imagen como no cargada
                loadedImagesCount++; // Asegura que el contador avance incluso con errores
                if (loadedImagesCount === totalImages) {
                    startGame();
                }
            };
        }

        // --- Objeto Jefe Final ---
        const boss = {
            x: canvas.width / 2 - TILE_SIZE * 2,
            y: GROUND_LEVEL - TILE_SIZE * 4,
            width: TILE_SIZE * 4,
            height: TILE_SIZE * 4,
            maxHealth: 1000,
            health: 1000,
            speed: 1,
            dir: 1, // 1 para derecha, -1 para izquierda
            shootTimer: 0,
            shootInterval: 90, // Cuadros entre disparos
            active: false, // Solo activo en el nivel del jefe
            initialX: canvas.width / 2 - TILE_SIZE * 2,
            moveRange: 150 // Rango de movimiento horizontal
        };

        // --- Niveles del Juego ---
        const levels = [
            // Nivel 1: Introducción
            {
                background: 'backgroundForest',
                platforms: [
                    { x: 0, y: GROUND_LEVEL, width: canvas.width, height: TILE_SIZE, img: 'platform' },
                    { x: 200, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 3, height: TILE_SIZE, img: 'platform' },
                    { x: 550, y: GROUND_LEVEL - TILE_SIZE * 3, width: TILE_SIZE * 2, height: TILE_SIZE, img: 'platform' }
                ],
                enemies: [
                    { x: 300, y: GROUND_LEVEL - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, img: 'goomber', speed: 1.5, type: 'goomber', dir: 1, initialX: 300, moveRange: 100 }
                ],
                obstacles: [],
                powerUps: [
                    { x: 100, y: GROUND_LEVEL - TILE_SIZE * 2, width: 20, height: 20, img: 'coin', type: 'score' }
                ],
                exit: { x: canvas.width - TILE_SIZE * 2, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE, height: TILE_SIZE, img: 'exitFlag' }
            },
            // Nivel 2: Primeros Spikes y más Goombers
            {
                background: 'backgroundForest',
                platforms: [
                    { x: 0, y: GROUND_LEVEL, width: canvas.width, height: TILE_SIZE, img: 'platform' },
                    { x: 150, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 3, height: TILE_SIZE, img: 'platform' },
                    { x: 500, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 2, height: TILE_SIZE, img: 'platform' }
                ],
                enemies: [
                    { x: 200, y: GROUND_LEVEL - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, img: 'goomber', speed: 2, type: 'goomber', dir: 1, initialX: 200, moveRange: 100 },
                    { x: 600, y: GROUND_LEVEL - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, img: 'goomber', speed: 2, type: 'goomber', dir: -1, initialX: 600, moveRange: 100 }
                ],
                obstacles: [
                    { x: 350, y: GROUND_LEVEL - 20, width: TILE_SIZE * 1.5, height: 20, img: 'spikeTrap', type: 'spike' }
                ],
                powerUps: [
                    { x: 50, y: GROUND_LEVEL - TILE_SIZE * 2, width: 20, height: 20, img: 'coin', type: 'score' }
                ],
                exit: { x: canvas.width - TILE_SIZE * 2, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE, height: TILE_SIZE, img: 'exitFlag' }
            },
            // Nivel 3: Spikers y Plataformas Elevadas
            {
                background: 'backgroundForest',
                platforms: [
                    { x: 0, y: GROUND_LEVEL, width: canvas.width, height: TILE_SIZE, img: 'platform' },
                    { x: 100, y: GROUND_LEVEL - TILE_SIZE * 3, width: TILE_SIZE * 2, height: TILE_SIZE, img: 'platform' },
                    { x: 400, y: GROUND_LEVEL - TILE_SIZE * 4, width: TILE_SIZE * 3, height: TILE_SIZE, img: 'platform' },
                    { x: 700, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 1.5, height: TILE_SIZE, img: 'platform' }
                ],
                enemies: [
                    { x: 450, y: GROUND_LEVEL - TILE_SIZE * 5, width: TILE_SIZE, height: TILE_SIZE, img: 'spiker', type: 'spiker' }
                ],
                obstacles: [
                    { x: 250, y: GROUND_LEVEL - 20, width: TILE_SIZE, height: 20, img: 'spikeTrap', type: 'spike' },
                    { x: 600, y: GROUND_LEVEL - 20, width: TILE_SIZE, height: 20, img: 'spikeTrap', type: 'spike' }
                ],
                powerUps: [
                    { x: 750, y: GROUND_LEVEL - TILE_SIZE * 3, width: 20, height: 20, img: 'heart', type: 'extraLife' }
                ],
                exit: { x: canvas.width - TILE_SIZE * 2, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE, height: TILE_SIZE, img: 'exitFlag' }
            },
            // Nivel 4: Primeros Flutterbys y Flor de Fuego
            {
                background: 'backgroundForest',
                platforms: [
                    { x: 0, y: GROUND_LEVEL, width: canvas.width, height: TILE_SIZE, img: 'platform' },
                    { x: 100, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 2, height: TILE_SIZE, img: 'platform' },
                    { x: 400, y: GROUND_LEVEL - TILE_SIZE * 3, width: TILE_SIZE * 2, height: TILE_SIZE, img: 'platform' }
                ],
                enemies: [
                    { x: 300, y: 100, width: TILE_SIZE, height: TILE_SIZE, img: 'flutterby', speed: 1, type: 'flutterby', dir: 1, initialY: 100, range: 50 }
                ],
                obstacles: [],
                powerUps: [
                    { x: 250, y: GROUND_LEVEL - TILE_SIZE * 3, width: 20, height: 20, img: 'fireFlower', type: 'fireFlower' }
                ],
                exit: { x: canvas.width - TILE_SIZE * 2, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE, height: TILE_SIZE, img: 'exitFlag' }
            },
            // Nivel 5: Turret Plants y Pinchos Móviles
            {
                background: 'backgroundCave',
                platforms: [
                    { x: 0, y: GROUND_LEVEL, width: canvas.width, height: TILE_SIZE, img: 'platform' },
                    { x: 250, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 4, height: TILE_SIZE, img: 'platform' }
                ],
                enemies: [
                    { x: 100, y: GROUND_LEVEL - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, img: 'goomber', speed: 1.5, type: 'goomber', dir: 1, initialX: 100, moveRange: 100 },
                    { x: 700, y: GROUND_LEVEL - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, img: 'goomber', speed: 1.5, type: 'goomber', dir: -1, initialX: 700, moveRange: 100 }
                ],
                obstacles: [
                    { x: 400, y: GROUND_LEVEL - 20, width: TILE_SIZE, height: 20, img: 'spikeTrap', type: 'spike', moving: true, initialY: GROUND_LEVEL - 20, maxY: GROUND_LEVEL - TILE_SIZE * 2, speed: 1, dir: 1 },
                    { x: 50, y: GROUND_LEVEL - 20, width: TILE_SIZE, height: TILE_SIZE, img: 'turretPlant', type: 'turretPlant', shootTimer: 0, shootInterval: 90 }
                ],
                powerUps: [],
                exit: { x: canvas.width - TILE_SIZE * 2, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE, height: TILE_SIZE, img: 'exitFlag' }
            },
            // Nivel 6: Plataformas que Desaparecen y Spikers
            {
                background: 'backgroundCave',
                platforms: [
                    { x: 0, y: GROUND_LEVEL, width: canvas.width, height: TILE_SIZE, img: 'platform' },
                    { x: 100, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 2, height: TILE_SIZE, img: 'crumblingPlatform', type: 'crumbling' },
                    { x: 300, y: GROUND_LEVEL - TILE_SIZE * 3, width: TILE_SIZE * 2, height: TILE_SIZE, img: 'platform' },
                    { x: 500, y: GROUND_LEVEL - TILE_SIZE * 4, width: TILE_SIZE * 2, height: TILE_SIZE, img: 'crumblingPlatform', type: 'crumbling' },
                    { x: 700, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 2, height: TILE_SIZE, img: 'platform' }
                ],
                enemies: [
                    { x: 350, y: GROUND_LEVEL - TILE_SIZE * 4, width: TILE_SIZE, height: TILE_SIZE, img: 'spiker', type: 'spiker' }
                ],
                obstacles: [],
                powerUps: [
                    { x: 50, y: GROUND_LEVEL - TILE_SIZE * 3, width: 20, height: 20, img: 'heart', type: 'extraLife' }
                ],
                exit: { x: canvas.width - TILE_SIZE * 2, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE, height: TILE_SIZE, img: 'exitFlag' }
            },
            // Nivel 7: Combinación de Enemigos y Obstáculos
            {
                background: 'backgroundCave',
                platforms: [
                    { x: 0, y: GROUND_LEVEL, width: canvas.width, height: TILE_SIZE, img: 'platform' },
                    { x: 100, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 2, height: TILE_SIZE, img: 'platform' },
                    { x: 400, y: GROUND_LEVEL - TILE_SIZE * 3, width: TILE_SIZE * 3, height: TILE_SIZE, img: 'platform' },
                    { x: 700, y: GROUND_LEVEL - TILE_SIZE * 4, width: TILE_SIZE * 2, height: TILE_SIZE, img: 'platform' }
                ],
                enemies: [
                    { x: 200, y: GROUND_LEVEL - TILE_SIZE, width: TILE_SIZE, height: TILE_SIZE, img: 'goomber', speed: 2, type: 'goomber', dir: 1, initialX: 200, moveRange: 100 },
                    { x: 500, y: 100, width: TILE_SIZE, height: TILE_SIZE, img: 'flutterby', speed: 1.5, type: 'flutterby', dir: 1, initialY: 100, range: 70 }
                ],
                obstacles: [
                    { x: 300, y: GROUND_LEVEL - 20, width: TILE_SIZE, height: 20, img: 'spikeTrap', type: 'spike' },
                    { x: 600, y: GROUND_LEVEL - 20, width: TILE_SIZE, height: TILE_SIZE, img: 'turretPlant', type: 'turretPlant', shootTimer: 0, shootInterval: 60 }
                ],
                powerUps: [],
                exit: { x: canvas.width - TILE_SIZE * 2, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE, height: TILE_SIZE, img: 'exitFlag' }
            },
            // Nivel 8: Más Movimiento y Peligro
            {
                background: 'backgroundCave',
                platforms: [
                    { x: 0, y: GROUND_LEVEL, width: canvas.width, height: TILE_SIZE, img: 'platform' },
                    { x: 150, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 2, height: TILE_SIZE, img: 'crumblingPlatform', type: 'crumbling' },
                    { x: 450, y: GROUND_LEVEL - TILE_SIZE * 3, width: TILE_SIZE * 3, height: TILE_SIZE, img: 'platform' },
                    { x: 750, y: GROUND_LEVEL - TILE_SIZE * 4, width: TILE_SIZE * 2, height: TILE_SIZE, img: 'platform' }
                ],
                enemies: [
                    { x: 200, y: GROUND_LEVEL - TILE_SIZE * 3, width: TILE_SIZE, height: TILE_SIZE, img: 'spiker', type: 'spiker' },
                    { x: 50, y: 50, width: TILE_SIZE, height: TILE_SIZE, img: 'flutterby', speed: 2, type: 'flutterby', dir: 1, initialY: 50, range: 100 }
                ],
                obstacles: [
                    { x: 300, y: GROUND_LEVEL - 20, width: TILE_SIZE, height: 20, img: 'spikeTrap', type: 'spike', moving: true, initialY: GROUND_LEVEL - 20, maxY: GROUND_LEVEL - TILE_SIZE * 3, speed: 1.5, dir: 1 }
                ],
                powerUps: [
                    { x: 600, y: GROUND_LEVEL - TILE_SIZE * 4, width: 20, height: 20, img: 'fireFlower', type: 'fireFlower' }
                ],
                exit: { x: canvas.width - TILE_SIZE * 2, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE, height: TILE_SIZE, img: 'exitFlag' }
            },
            // Nivel 9: Desafío de Habilidad
            {
                background: 'backgroundCave',
                platforms: [
                    { x: 0, y: GROUND_LEVEL, width: canvas.width, height: TILE_SIZE, img: 'platform' },
                    { x: 100, y: GROUND_LEVEL - TILE_SIZE * 4, width: TILE_SIZE * 2, height: TILE_SIZE, img: 'crumblingPlatform', type: 'crumbling' },
                    { x: 400, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 3, height: TILE_SIZE, img: 'platform' },
                    { x: 700, y: GROUND_LEVEL - TILE_SIZE * 5, width: TILE_SIZE * 2, height: TILE_SIZE, img: 'platform' }
                ],
                enemies: [
                    { x: 500, y: GROUND_LEVEL - TILE_SIZE * 3, width: TILE_SIZE, height: TILE_SIZE, img: 'goomber', speed: 2.5, type: 'goomber', dir: 1, initialX: 500, moveRange: 100 },
                    { x: 200, y: 150, width: TILE_SIZE, height: TILE_SIZE, img: 'flutterby', speed: 2, type: 'flutterby', dir: 1, initialY: 150, range: 120 }
                ],
                obstacles: [
                    { x: 250, y: GROUND_LEVEL - 20, width: TILE_SIZE * 3, height: 20, img: 'spikeTrap', type: 'spike' },
                    { x: 700, y: GROUND_LEVEL - 20, width: TILE_SIZE, height: TILE_SIZE, img: 'turretPlant', type: 'turretPlant', shootTimer: 0, shootInterval: 45 }
                ],
                powerUps: [],
                exit: { x: canvas.width - TILE_SIZE * 2, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE, height: TILE_SIZE, img: 'exitFlag' }
            },
            // Nivel 10: ¡El JEFE FINAL!
            {
                background: 'backgroundLava',
                platforms: [
                    { x: 0, y: GROUND_LEVEL, width: canvas.width, height: TILE_SIZE, img: 'platform' },
                    { x: canvas.width / 2 - TILE_SIZE * 2, y: GROUND_LEVEL - TILE_SIZE * 2, width: TILE_SIZE * 4, height: TILE_SIZE, img: 'platform' } // Plataforma para el jefe
                ],
                enemies: [], // No hay enemigos normales, solo el jefe
                obstacles: [],
                powerUps: [
                    { x: 100, y: GROUND_LEVEL - TILE_SIZE * 2, width: 20, height: 20, img: 'fireFlower', type: 'fireFlower' } // Asegurar que el jugador tenga el arma
                ],
                exit: null, // No hay salida, se termina al derrotar al jefe
                isBossLevel: true
            }
        ];

        let currentLevelData;
        let gameProjectiles = []; // Proyectiles del jugador y de las torretas

        // --- Inicializar Nivel ---
        function loadLevel(levelNum) {
            if (levelNum >= levels.length) {
                console.log("¡Felicidades, has completado el juego!");
                showGameOver(true); // Victoria
                return;
            }
            currentLevelData = JSON.parse(JSON.stringify(levels[levelNum])); // Copia profunda
            player.x = 50;
            player.y = GROUND_LEVEL - TILE_SIZE;
            player.velocityY = 0;
            player.isJumping = false;
            player.onGround = true;
            player.invincible = false;
            player.invincibilityTimer = 0;
            gameProjectiles = []; // Limpiar proyectiles al cambiar de nivel
            levelDisplay.textContent = currentLevelIndex + 1;

            // Reiniciar estado del jefe si es el nivel del jefe
            if (currentLevelData.isBossLevel) {
                boss.active = true;
                boss.health = boss.maxHealth;
                boss.x = boss.initialX;
                boss.dir = 1;
                bossHealthBar.style.display = 'block'; // Mostrar barra de vida del jefe
                updateBossHealthBar();
            } else {
                boss.active = false;
                bossHealthBar.style.display = 'none'; // Ocultar barra de vida del jefe
            }
        }

        // --- Bucle Principal del Juego ---
        function gameLoop() {
            if (!gameRunning) return;

            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // --- Actualizar Estado del Juego ---
        function update() {
            // 1. Movimiento del Jugador
            if (keys.right) player.x += player.speed;
            if (keys.left) player.x -= player.speed;

            // Limitar movimiento dentro del canvas
            if (player.x < 0) player.x = 0;
            if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;

            // Aplicar gravedad
            player.velocityY += GRAVITY;
            player.y += player.velocityY;

            // Reiniciar onGround
            player.onGround = false;

            // Colisión con el suelo (borde inferior del canvas)
            if (player.y + player.height > GROUND_LEVEL) {
                player.y = GROUND_LEVEL - player.height;
                player.velocityY = 0;
                player.isJumping = false;
                player.onGround = true;
            }

            // Colisión con plataformas
            currentLevelData.platforms.forEach(platform => {
                // Si el jugador está cayendo y colisiona con la parte superior de una plataforma
                if (player.velocityY >= 0 &&
                    player.x < platform.x + platform.width &&
                    player.x + player.width > platform.x &&
                    player.y + player.height <= platform.y + player.velocityY && // La línea inferior del jugador está encima o al nivel de la parte superior de la plataforma
                    player.y + player.height + player.velocityY > platform.y) { // Y la próxima posición del jugador estará por debajo de la parte superior de la plataforma
                    player.y = platform.y - player.height;
                    player.velocityY = 0;
                    player.isJumping = false;
                    player.onGround = true;

                    if (platform.type === 'crumbling' && !platform.crumbled) {
                        platform.crumbleTimer = platform.crumbleTimer || 0;
                        platform.crumbleTimer++;
                        if (platform.crumbleTimer > 30) { // 0.5 segundos (30 cuadros) antes de que se rompa
                            platform.crumbled = true;
                            // Opcional: Eliminar la plataforma después de un tiempo si se desea
                            setTimeout(() => {
                                const index = currentLevelData.platforms.indexOf(platform);
                                if (index > -1) {
                                    currentLevelData.platforms.splice(index, 1);
                                }
                            }, 500); // Se elimina 0.5 segundos después de romperse visualmente
                        }
                    }
                }
            });

            // Salto
            if (keys.space && player.onGround && !player.isJumping) {
                player.velocityY = -10; // Fuerza de salto
                player.isJumping = true;
                player.onGround = false; // Ya no está en el suelo una vez que salta
            }

            // Disparo
            if (keys.fire && player.hasFirePower && keys.canFire) {
                player.projectiles.push({
                    x: player.x + player.width / 2,
                    y: player.y + player.height / 2,
                    width: 10,
                    height: 10,
                    speed: 8,
                    dir: keys.right ? 1 : (keys.left ? -1 : 1) // Dispara en la dirección en la que mira o por defecto a la derecha
                });
                keys.canFire = false;
                setTimeout(() => {
                    keys.canFire = true;
                }, 300); // Cooldown de disparo (0.3 segundos)
            }

            // Actualizar proyectiles del jugador
            player.projectiles.forEach((p, index) => {
                p.x += p.speed * p.dir;
                if (p.x < 0 || p.x > canvas.width) {
                    player.projectiles.splice(index, 1);
                }
            });

            // Manejar invencibilidad del jugador
            if (player.invincible) {
                player.invincibilityTimer++;
                if (player.invincibilityTimer >= player.maxInvincibilityTime) {
                    player.invincible = false;
                    player.invincibilityTimer = 0;
                }
            }

            // 2. Movimiento y Lógica de Enemigos
            currentLevelData.enemies.forEach(enemy => {
                if (enemy.type === 'goomber') {
                    enemy.x += enemy.speed * enemy.dir;
                    // Cambiar dirección si alcanza los límites de su rango de movimiento
                    if (enemy.x > enemy.initialX + enemy.moveRange || enemy.x < enemy.initialX - enemy.moveRange) {
                        enemy.dir *= -1;
                    }
                } else if (enemy.type === 'flutterby') {
                    enemy.y += enemy.speed * enemy.dir;
                    if (enemy.y > enemy.initialY + enemy.range || enemy.y < enemy.initialY - enemy.range) {
                        enemy.dir *= -1;
                    }
                }
            });

            // Actualizar obstáculos (trampas móviles y torretas)
            currentLevelData.obstacles.forEach(obstacle => {
                if (obstacle.type === 'spike' && obstacle.moving) {
                    obstacle.y += obstacle.speed * obstacle.dir;
                    if (obstacle.y > obstacle.maxY || obstacle.y < obstacle.initialY) {
                        obstacle.dir *= -1;
                    }
                } else if (obstacle.type === 'turretPlant') {
                    obstacle.shootTimer++;
                    if (obstacle.shootTimer >= obstacle.shootInterval) {
                        gameProjectiles.push({
                            x: obstacle.x + obstacle.width / 2,
                            y: obstacle.y + obstacle.height / 2,
                            width: 15,
                            height: 15,
                            speed: 5,
                            dir: (player.x < obstacle.x) ? -1 : 1, // Dispara hacia el jugador
                            isEnemyProjectile: true
                        });
                        obstacle.shootTimer = 0;
                    }
                }
            });

            // Actualizar proyectiles del juego (enemigos)
            gameProjectiles.forEach((p, index) => {
                p.x += p.speed * p.dir;
                if (p.x < 0 || p.x > canvas.width) {
                    gameProjectiles.splice(index, 1);
                }
            });

            // 3. Colisiones
            // Colisión Jugador-Enemigo/Obstáculo
            currentLevelData.enemies.forEach(enemy => {
                if (!player.invincible && checkCollision(player, enemy)) {
                    if (player.velocityY > 0 && player.y + player.height - player.velocityY <= enemy.y + 10) { // Si el jugador cae sobre el enemigo
                        score += 100;
                        enemy.x = -100; // Mover enemigo fuera de pantalla para "eliminarlo"
                        player.velocityY = -7; // Pequeño rebote
                    } else {
                        lives--;
                        livesDisplay.textContent = lives;
                        player.invincible = true;
                        player.invincibilityTimer = 0;
                        if (lives <= 0) {
                            showGameOver(false);
                        }
                    }
                }
            });

            currentLevelData.obstacles.forEach(obstacle => {
                if (!player.invincible && obstacle.type === 'spike' && checkCollision(player, obstacle)) {
                    lives--;
                    livesDisplay.textContent = lives;
                    player.invincible = true;
                    player.invincibilityTimer = 0;
                    if (lives <= 0) {
                        showGameOver(false);
                    }
                }
            });

            // Colisión Jugador-Proyectil Enemigo
            gameProjectiles.forEach((p, index) => {
                if (p.isEnemyProjectile && !player.invincible && checkCollision(player, p)) {
                    lives--;
                    livesDisplay.textContent = lives;
                    player.invincible = true;
                    player.invincibilityTimer = 0;
                    gameProjectiles.splice(index, 1); // Eliminar proyectil
                    if (lives <= 0) {
                        showGameOver(false);
                    }
                }
            });

            // Colisión Proyectil Jugador-Enemigo
            player.projectiles.forEach((proj, projIndex) => {
                currentLevelData.enemies.forEach((enemy, enemyIndex) => {
                    if (checkCollision(proj, enemy) && enemy.type !== 'spiker') { // Spiker no es afectado por proyectiles (solo si decides esto)
                        score += 100;
                        currentLevelData.enemies.splice(enemyIndex, 1); // Eliminar enemigo
                        player.projectiles.splice(projIndex, 1); // Eliminar proyectil
                    }
                });

                // Colisión Proyectil Jugador-Jefe
                if (boss.active && checkCollision(proj, boss)) {
                    boss.health -= 50; // Daño al jefe
                    updateBossHealthBar();
                    player.projectiles.splice(projIndex, 1); // Eliminar proyectil

                    if (boss.health <= 0) {
                        score += 5000; // Puntos extra por derrotar al jefe
                        boss.active = false;
                        showGameOver(true); // Victoria
                    }
                }
            });

            // Colisión Jugador-PowerUp
            currentLevelData.powerUps.forEach((powerUp, index) => {
                if (checkCollision(player, powerUp)) {
                    if (powerUp.type === 'score') {
                        score += 50;
                    } else if (powerUp.type === 'extraLife') {
                        lives++;
                        livesDisplay.textContent = lives;
                    } else if (powerUp.type === 'fireFlower') {
                        player.hasFirePower = true;
                    }
                    currentLevelData.powerUps.splice(index, 1); // Eliminar power-up
                    scoreDisplay.textContent = score;
                }
            });

            // 4. Lógica del Jefe Final
            if (boss.active) {
                // Movimiento del jefe
                boss.x += boss.speed * boss.dir;
                if (boss.x > boss.initialX + boss.moveRange || boss.x < boss.initialX - boss.moveRange) {
                    boss.dir *= -1;
                }

                // Disparo del jefe
                boss.shootTimer++;
                if (boss.shootTimer >= boss.shootInterval) {
                    gameProjectiles.push({
                        x: boss.x + boss.width / 2,
                        y: boss.y + boss.height, // Dispara desde la base del jefe
                        width: 20,
                        height: 20,
                        speed: 7,
                        dir: (player.x < boss.x) ? -1 : 1, // Dispara hacia el jugador
                        isEnemyProjectile: true,
                        isBossProjectile: true
                    });
                    boss.shootTimer = 0;
                }
            }


            // 5. Nivel Completado
            if (!currentLevelData.isBossLevel && currentLevelData.exit && checkCollision(player, currentLevelData.exit)) {
                currentLevelIndex++;
                loadLevel(currentLevelIndex);
            }

            scoreDisplay.textContent = score;
        }

        // --- Dibujar Elementos del Juego ---
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Limpiar canvas

            // Dibujar fondo
            if (images[currentLevelData.background]) {
                ctx.drawImage(images[currentLevelData.background], 0, 0, canvas.width, canvas.height);
            } else {
                ctx.fillStyle = '#7fd4e7'; // Color de fallback si la imagen no carga
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            // Dibujar plataformas
            currentLevelData.platforms.forEach(platform => {
                if (!platform.crumbled) { // Solo dibujar si no se ha desmoronado
                    if (images[platform.img]) {
                        ctx.drawImage(images[platform.img], platform.x, platform.y, platform.width, platform.height);
                    } else {
                        ctx.fillStyle = '#8B4513'; // Color de fallback
                        ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                    }
                }
            });

            // Dibujar jugador
            const playerImage = player.hasFirePower ? images.playerFire : images.player;
            if (playerImage) {
                ctx.save();
                if (player.invincible) {
                    ctx.globalAlpha = 0.5 + Math.sin(player.invincibilityTimer * 0.5) * 0.2; // Efecto de parpadeo
                }
                ctx.drawImage(playerImage, player.x, player.y, player.width, player.height);
                ctx.restore();
            } else {
                ctx.fillStyle = 'blue'; // Color de fallback
                ctx.fillRect(player.x, player.y, player.width, player.height);
            }

            // Dibujar enemigos
            currentLevelData.enemies.forEach(enemy => {
                if (images[enemy.img]) {
                    ctx.drawImage(images[enemy.img], enemy.x, enemy.y, enemy.width, enemy.height);
                } else {
                    ctx.fillStyle = 'red'; // Color de fallback
                    ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
                }
            });

            // Dibujar obstáculos
            currentLevelData.obstacles.forEach(obstacle => {
                if (images[obstacle.img]) {
                    ctx.drawImage(images[obstacle.img], obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                } else {
                    ctx.fillStyle = 'gray'; // Color de fallback
                    ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                }
            });

            // Dibujar power-ups
            currentLevelData.powerUps.forEach(powerUp => {
                if (images[powerUp.img]) {
                    ctx.drawImage(images[powerUp.img], powerUp.x, powerUp.y, powerUp.width, powerUp.height);
                } else {
                    ctx.fillStyle = 'yellow'; // Color de fallback
                    ctx.fillRect(powerUp.x, powerUp.y, powerUp.width, powerUp.height);
                }
            });

            // Dibujar bandera de salida
            if (!currentLevelData.isBossLevel && currentLevelData.exit && images[currentLevelData.exit.img]) {
                ctx.drawImage(images[currentLevelData.exit.img], currentLevelData.exit.x, currentLevelData.exit.y, currentLevelData.exit.width, currentLevelData.exit.height);
            }

            // Dibujar proyectiles del jugador
            player.projectiles.forEach(p => {
                if (images.playerFireball) {
                    ctx.drawImage(images.playerFireball, p.x, p.y, p.width, p.height);
                } else {
                    ctx.fillStyle = 'orange';
                    ctx.fillRect(p.x, p.y, p.width, p.height);
                }
            });

            // Dibujar proyectiles de enemigos/jefe
            gameProjectiles.forEach(p => {
                const projImage = p.isBossProjectile ? images.bossProjectile : images.enemyProjectile;
                if (projImage) {
                    ctx.drawImage(projImage, p.x, p.y, p.width, p.height);
                } else {
                    ctx.fillStyle = 'purple';
                    ctx.fillRect(p.x, p.y, p.width, p.height);
                }
            });

            // Dibujar jefe final
            if (boss.active && images.boss) {
                ctx.drawImage(images.boss, boss.x, boss.y, boss.width, boss.height);
            } else if (boss.active) {
                ctx.fillStyle = 'darkred'; // Color de fallback
                ctx.fillRect(boss.x, boss.y, boss.width, boss.height);
            }
        }

        // --- Funciones de Utilidad ---
        function checkCollision(obj1, obj2) {
            return obj1.x < obj2.x + obj2.width &&
                obj1.x + obj1.width > obj2.x &&
                obj1.y < obj2.y + obj2.height &&
                obj1.y + obj1.height > obj2.y;
        }

        function updateBossHealthBar() {
            bossHealthFill.style.width = `${(boss.health / boss.maxHealth) * 100}%`;
        }

        function showGameOver(isVictory) {
            gameRunning = false;
            gameOverScreen.classList.remove('hidden');
            if (isVictory) {
                gameOverTitle.textContent = "¡Has Ganado!";
                gameOverTitle.style.color = '#27ae60';
            } else {
                gameOverTitle.textContent = "¡Juego Terminado!";
                gameOverTitle.style.color = '#e74c3c';
            }
            finalScoreDisplay.textContent = score;
        }

        function resetGame() {
            score = 0;
            lives = 3;
            currentLevelIndex = 0;
            player.hasFirePower = false; // Reiniciar poder de fuego
            scoreDisplay.textContent = score;
            livesDisplay.textContent = lives;
            loadLevel(currentLevelIndex);
            gameOverScreen.classList.add('hidden');
            gameRunning = true;
            gameLoop();
        }

        // --- Event Listeners ---
        document.addEventListener('keydown', (e) => {
            if (e.code === 'ArrowRight') keys.right = true;
            if (e.code === 'ArrowLeft') keys.left = true;
            if (e.code === 'Space') keys.space = true;
            if (e.code === 'KeyF') keys.fire = true; // 'F' para disparar
        });

        document.addEventListener('keyup', (e) => {
            if (e.code === 'ArrowRight') keys.right = false;
            if (e.code === 'ArrowLeft') keys.left = false;
            if (e.code === 'Space') keys.space = false;
            if (e.code === 'KeyF') keys.fire = false;
        });

        restartButton.addEventListener('click', resetGame);

        // --- Iniciar el Juego ---
        function startGame() {
            loadingScreen.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            loadLevel(currentLevelIndex);
            gameRunning = true;
            gameLoop();
        }

        // Cargar todas las imágenes al inicio
        for (const name in imageSources) {
            loadImage(name, imageSources[name]);
        }
    </script>
</body>
</html>
